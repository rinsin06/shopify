<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<head th:replace = "fragments :: html_head"></head>
<body>
<!--Header Starts-->
<div th:replace = "fragments :: user_header"></div>
<!--Header Ends-->
<div class="container">

    <!--Section: Block Content-->
    <section class="mt-5 mb-4">

        <!--Grid row-->
        <div class="row">

            <!--Grid column-->
            <div class="col-lg-8 mb-4">

                <!-- Card -->
                <div class="card wish-list pb-1">
                    <div class="card-body">

                        <h5 class="mb-2">Billing details</h5>

                        <div class="d-flex align-items-center gap-2">
                            <a th:href="@{/add-address(fromCheckout=true)}"><button class="btn btn-primary fs-2" >Add New Address</button></a>
                        </div>

                        <hr>



                        <form id="checkoutForm" th:action="@{/placeOrderBuy}" method="post">

                            <input type="hidden" name="productId" th:value="${product.get().id}" />
                            <input type="hidden" name="productName" th:value="${product.get().name}" />
                            <input type="hidden" name="productPrice" th:value="${product.get().price}" />

                            <div class="form-group">
                                <label for="savedAddresses">Select Address:</label>
                                <select id="savedAddresses" name="selectedAddressId" class="form-control">
                                    <option value="">Select an Address</option>
                                    <option th:each="address : ${addresses}"
                                            th:value="${address.id}"
                                            th:text="${address.fullName + ', ' + address.mobilePhoneNumber + ', ' + address.buildingNo + ', ' + address.street + ', ' + address.landmark + ', ' + address.city + ', ' + address.state + ', ' + address.pinCode + ', ' + address.country.name}"
                                            th:selected="${address.defaultAddress}"></option>
                                </select>
                            </div>

                            <hr>

                            <div>
                                <label>Choose your payment method:</label>
                                <div class="form-check">
                                    <input type="radio" id="cashOnDelivery" name="paymentMethod" value="Cash On Delivery" class="form-check-input" checked>
                                    <label class="form-check-label" for="cashOnDelivery">Cash on Delivery</label>
                                </div>
                                <div class="form-check">
                                    <input type="radio" id="onlinePay" name="paymentMethod" value="Online Payment" class="form-check-input" >
                                    <label class="form-check-label" for="onlinePay">Online Payment</label>
                                </div>
                            </div>

                            <hr>

                            <button type="submit" id="placeOrderButton" class="btn btn-primary btn-block waves-effect waves-light">Place Order</button>
                            <button id="paymentPlaceOrderButton" class="btn btn-primary btn-block waves-effect waves-light" style="display:none;">Payment Place Order</button>
                        </form>

                        <hr>



                        <hr>


                    </div>
                </div>
                <!-- Card -->

            </div>
            <!--Grid column-->

            <!--Grid column-->
            <div class="col-lg-4">

                <!-- Card -->
                <div class="card mb-4">
                    <div class="card-body">

                        <h5 class="mb-3">The total amount </h5>

                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 pb-0">
                                Sub Total
                                <span>₹<span th:text="${totalProductAmount}"></span></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                Shipping
                                <span>OneCart Delivery</span>
                                <span>₹<span th:text="${shippingCharge}"></span></span>
                            </li>
                             <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                Discount
                                <span>-₹<span th:text="${discountAmount}"></span></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                Tax (5%)
                                <span>₹<span th:text="${taxAmount}"></span></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 mb-3">
                                <div>
                                    <strong>Total Amount (including VAT)</strong>
                                </div>
                                <span id="cartTotal"><strong>₹<span th:text="${total}"></span></strong></span>
                            </li>
                        </ul>
                        <hr>
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="d-flex flex-column mb-3">
                                    <h5 class="mb-2">Selected Products</h5>
                                    <span th:if="${product.isPresent()}" th:text="${product.get().name}"></span><br>
                                    <span class="ml-2 text-muted" th:if="${product.isPresent()}">Price: ₹<span th:text="${product.get().price}"></span></span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <!-- Card -->

                <!-- Card -->
                <div class="card mb-4">
                    <div class="card-body">

                        <!--                        <a class="dark-grey-text d-flex justify-content-between" data-toggle="collapse" href="#collapseExample"-->
                        <!--                           aria-expanded="false" aria-controls="collapseExample">-->
                        <!--                            Add a discount code (optional)-->
                        <!--                            <span><i class="fas fa-chevron-down pt-1"></i></span>-->
                        <!--                        </a>-->

                        <!--                        <div class="collapse" id="collapseExample">-->
                        <!--                            <div class="mt-3">-->
                        <!--                                <div class="md-form md-outline mb-0">-->
                        <!--                                    <input type="text" id="discount-code" class="form-control font-weight-light"-->
                        <!--                                           placeholder="Enter discount code">-->
                        <!--                                </div>-->
                        <!--                            </div>-->
                        <!--                        </div>-->

                        <!-- Display Applied Coupon Information -->
                        <div th:if="${appliedCoupon}">
                            <p>Applied Coupon: <strong th:text="${appliedCoupon.code}"></strong></p>
                            <p>Coupon Discount: <strong th:text="${appliedCoupon.discountPercentage}"></strong>%</p>
                            <div th:if="${appliedCoupon}">
                            <form  th:action="@{/removeSingleCoupon}" method ="post">
                            <input type="hidden" id="productId" name="productId" th:value="${product.isPresent() ? product.get().id : ''}" />
                            <button class="btn btn-primary" type="submit">Remove Coupon</button>
                            </form>
                            </div>
                        </div>
                        <div th:unless="${appliedCoupon}">
                            <p>No Coupon Applied</p>
                        </div>

                        <!-- Apply Coupon Form -->
                        <div class="collapse" id="couponFormCollapse">
                            <form th:action="@{/applySingleCoupon}" method="post">
                            <input type="hidden" id="productId" name="productId" th:value="${product.isPresent() ? product.get().id : ''}" />
                                <div class="form-group">
                                    <label for="couponCode">Coupon Code:</label>
                                    <input type="text" class="form-control" id="couponCode" name="couponCode" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Apply Coupon</button>
                            </form>
                        </div>
                         <div th:unless="${appliedCoupon}">
                        <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#couponFormCollapse">
                            Apply Coupon
                        </button>
                        </div>
                    </div>
                </div>
                <!-- Card -->

            </div>
            <!--Grid column-->

        </div>
        <!--Grid row-->

    </section>
    <!--Section: Block Content-->


</div>

<div class="py-6 px-6 text-center">
    <footer th:replace = "fragments :: footer"></footer>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>

<script>
    const cashOnDeliveryRadio = document.getElementById('cashOnDelivery');
    const onlinePayRadio = document.getElementById('onlinePay');
    const placeOrderButton = document.getElementById('placeOrderButton');
    const paymentPlaceOrderButton = document.getElementById('paymentPlaceOrderButton');
    const checkoutForm = document.getElementById('checkoutForm');

    paymentPlaceOrderButton.addEventListener('click', (event) => {
        event.preventDefault();
        paymentStart();
    });

    cashOnDeliveryRadio.addEventListener('change', () => {
        placeOrderButton.style.display = 'block';
        paymentPlaceOrderButton.style.display = 'none';
    });

    onlinePayRadio.addEventListener('change', () => {
        placeOrderButton.style.display = 'none';
        paymentPlaceOrderButton.style.display = 'block';
    });
</script>

<!--first-request to server to create an order-->
<script>
    const paymentStart = () => {
        console.log("Payment Started...");
        let amount = $("#cartTotal span").text();
        console.log(amount);

        if(amount == "" || amount == null) {
        alert("amount is required");
        swal("Sorry!", "amount is required", "error");
        return;
        }

        $.ajax(
            {
                url:"/create_order",
                data:JSON.stringify({amount:amount, info:"order_request"}),
                contentType: "application/json",
                type:"POST",
                dataType: "json",
                success:function(response){
                    //invoked when success
                    console.log(response);
                    if(response.status == "created") {
                        //open payment form
                        let options = {
                            key: "rzp_test_ylAcJVF7HqWbSw",
                            amount:response.amount,
                            currency:"INR",
                            name:"Shopify",
                            description:"Shopify Online Payment",
                            //image:"";
                            order_id:response.id,
                            handler:function(response){
                                console.log(response.razorpay_payment_id);
                                console.log(response.razorpay_order_id);
                                console.log(response.razorpay_signature);
                                console.log("payment successful!");
                                //alert("congratulations! Payment successful.");
                                updatePaymentOnServer(response.razorpay_payment_id,
                                 response.razorpay_order_id,
                                 'paid');

                                checkoutForm.submit();
                            },
                            prefill: {
                                name: "",
                                email: "",
                                contact: ""
                            },
                            notes: {
                                address: "Shopify Corporate Office"
                            },
                            theme: {
                                color: "#3399cc"
                            }
                        };

                        let rzp = new Razorpay(options);
                        rzp.on('payment.failed', function (response){
                            console.log(response.error.code);
                            console.log(response.error.description);
                            console.log(response.error.source);
                            console.log(response.error.step);
                            console.log(response.error.reason);
                            console.log(response.error.metadata.order_id);
                            console.log(response.error.metadata.payment_id);
                            //alert("Oops payment failed!");
                            swal("Sorry!", "Oops payment failed!", "error");
                        });
                        rzp.open();
                    }
                },
                error:function(error){
                    //invoked when unsuccessful
                    console.error(error);
                    //alert("something went wrong!!");
                    swal("Sorry!", "something went wrong!!", "error");
                }
            }
        )
    };

    function updatePaymentOnServer(payment_id, order_id, status)
    {
        $.ajax({
            url:"/update_order",
                data:JSON.stringify({payment_id: payment_id, order_id: order_id, status: status}),
                contentType: "application/json",
                type:"POST",
                dataType: "json",
                success:function(response){
                    swal("Good Job!", "congratulations!, payment successful", "success");
                },
                error:function(error){
                    swal("Sorry!", "Oops payment failed!", "error");
                },
        })
    }
</script>

</body>
</html>